<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Camera Minimal Component</title>
  <style>
    :root { --aspect-x:4; --aspect-y:5; }
    @media (orientation: landscape){ :root { --aspect-x:16; --aspect-y:9; } }
    html,body { margin:0; background:transparent; font-family:system-ui,-apple-system,Segoe UI,Roboto; }
    .wrap {
      width:min(92vw,640px);
      aspect-ratio:var(--aspect-x)/var(--aspect-y);
      margin:0 auto;
      border:16px solid #4a3b2e; border-radius:24px;
      box-shadow:0 10px 30px rgba(0,0,0,.15);
      overflow:hidden; background:#0f0f11;
      display:grid; place-items:center;
    }
    @media (orientation: landscape){ .wrap { width:min(92vw,960px); } }
    canvas { width:100%; height:100%; display:block; }
    .bar { display:grid; grid-template-columns:1fr 1fr; gap:.75rem; width:min(92vw,640px); margin:.75rem auto 0; }
    @media (orientation: landscape){ .bar { width:min(92vw,960px); } }
    button { padding:.75rem 1rem; border-radius:12px; border:0; font-size:1rem; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,.15); }
    .primary { background:#2b7cff; color:#fff; }
    .secondary { background:#eee; }
    .enable { background:#2b7cff; color:#fff; margin:.75rem auto; display:block; }
    .hint { text-align:center; opacity:.85; font:14px/1.4 system-ui; margin:.5rem 0 0; }
    .status { text-align:center; font:14px/1.4 system-ui; margin-top:.5rem; color:#bbb; }
    .error { color:#ff5d5d; }
  </style>
</head>
<body>
  <button id="enable" class="enable">Enable camera</button>

  <div class="wrap" id="wrap" style="display:none;">
    <video id="video" playsinline muted style="display:none"></video>
    <canvas id="canvas"></canvas>
  </div>

  <div class="bar" id="bar" style="display:none;">
    <button class="primary" id="capture">Capture</button>
    <button class="secondary" id="retake" disabled>Retake</button>
  </div>

  <div class="hint">Uses the current device camera. Frame adapts to orientation.</div>
  <div class="status" id="status">Click “Enable camera” to start.</div>

  <script>
    /* ---------- Streamlit handshake (apiVersion=1) ---------- */
    const API = 1;
    function post(msg){ try{ parent.postMessage(msg, "*"); } catch(e){} }
    function setFrameHeight(h){ post({ isStreamlitMessage:true, type:"streamlit:resize", height:h, apiVersion:API }); }
    function setComponentValue(val){ post({ isStreamlitMessage:true, type:"streamlit:setComponentValue", value:val, apiVersion:API }); }
    function setReady(){ post({ isStreamlitMessage:true, type:"streamlit:componentReady", apiVersion:API }); }
    function bump(){ setFrameHeight(document.body.scrollHeight || 720); }

    // Signal ready & keep iframe from collapsing
    window.addEventListener("DOMContentLoaded", () => {
      setReady(); bump();
      setTimeout(setReady, 50);
      setTimeout(setReady, 300);
      setTimeout(bump, 50);
      setTimeout(bump, 300);
    });
    window.addEventListener("load", () => { setReady(); bump(); });
    window.addEventListener("resize", bump);
    setInterval(bump, 200);

    /* ------------------- Camera (canvas-based preview) ------------------- */
    const btnEnable = document.getElementById("enable");
    const wrap = document.getElementById("wrap");
    const bar = document.getElementById("bar");
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const btnCap = document.getElementById("capture");
    const btnRet = document.getElementById("retake");
    const statusEl = document.getElementById("status");
    const ctx = canvas.getContext("2d");

    let stream = null;
    let rafId = null;

    function setStatus(msg, err=false){ statusEl.textContent = msg; statusEl.className = "status"+(err?" error":""); bump(); }

    function sizeCanvasToWrap(){
      const r = wrap.getBoundingClientRect();
      const w = Math.max(1, Math.round(r.width));
      const h = Math.max(1, Math.round(r.height));
      if (canvas.width !== w || canvas.height !== h){ canvas.width = w; canvas.height = h; }
    }

    function drawLoop(){
      sizeCanvasToWrap();
      const vw = video.videoWidth, vh = video.videoHeight;
      if (vw && vh){
        const cw = canvas.width, ch = canvas.height;
        const vA = vw/vh, cA = cw/ch;
        let sx=0, sy=0, sw=vw, sh=vh;
        if (vA > cA){ const tw = vh*cA; sx=(vw-tw)/2; sw=tw; }
        else { const th = vw/cA; sy=(vh-th)/2; sh=th; }
        ctx.drawImage(video, sx, sy, sw, sh, 0, 0, cw, ch);
      }
      rafId = requestAnimationFrame(drawLoop);
    }

    async function startCamera(){
      try{
        setStatus("Requesting camera permission…");
        const constraints = { video: { facingMode:{ideal:"user"}, width:{ideal:1280}, height:{ideal:720}, frameRate:{ideal:30} }, audio:false };
        try { stream = await navigator.mediaDevices.getUserMedia(constraints); }
        catch(e1){ stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false }); }

        video.srcObject = stream;
        // Wait for metadata (Edge may not fire reliably; use timeout fallback)
        await new Promise(res => {
          let done=false;
          const ok=()=>{ if(!done){ done=true; res(); } };
          video.addEventListener("loadedmetadata", ok, {once:true});
          setTimeout(ok, 800);
        });
        await video.play().catch(()=>{});

        wrap.style.display = "grid";
        bar.style.display  = "grid";
        btnEnable.style.display = "none";
        setStatus("Camera started.");
        cancelAnimationFrame(rafId); rafId = requestAnimationFrame(drawLoop);
      }catch(e){
        const secure = window.isSecureContext;
        setStatus(`Camera failed (${e.name}: ${e.message}). `+(secure?"Check site/OS permissions.":"Use HTTPS or localhost."), true);
      }finally{ bump(); }
    }

    function capture(){
      const dataUrl = canvas.toDataURL("image/jpeg", 0.9);
      btnRet.disabled = false;
      setStatus("Photo captured. You can Continue in the app.");
      setComponentValue({ status:"captured", dataUrl });
      bump();
    }

    function retake(){
      btnRet.disabled = true;
      setStatus("Ready – capture again.");
      setComponentValue({ status:"retake" });
      bump();
    }

    btnEnable.addEventListener("click", startCamera);
    btnCap.addEventListener("click", capture);
    btnRet.addEventListener("click", retake);

    window.addEventListener("beforeunload", () => {
      if (rafId) cancelAnimationFrame(rafId);
      if (stream) stream.getTracks().forEach(t => t.stop());
    });
  </script>
</body>
</html>
